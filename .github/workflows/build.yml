name: Build Workflow

on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string
        description: 'Build target name'
      os:
        required: true
        type: string
        description: 'Runner OS'
      setupCommand:
        required: true
        type: string
        description: 'Setup command to run'
      buildArgs:
        required: true
        type: string
        description: 'Build arguments for lime'
      artifactName:
        required: true
        type: string
        description: 'Artifact name for upload'
      artifactPath:
        required: true
        type: string
        description: 'Path to artifact files'

env:
  HAXE_VERSION: 4.3.6
  PROJECT_NAME: PsychEngine
  BUILD_CACHE_KEY: ${{ github.sha }}

jobs:
  build:
    name: Build for ${{ inputs.name }}
    runs-on: ${{ inputs.os }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Haxe Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.haxe
            ~/.haxelib
            project/.haxelib
          key: haxe-${{ env.BUILD_CACHE_KEY }}
          restore-keys: |
            haxe-

      - name: Setup Haxe
        uses: krdlab/setup-haxe@v2
        with:
          haxe-version: ${{ env.HAXE_VERSION }}

      - name: Setup Android Environment
        if: inputs.name == 'Android'
        uses: android-actions/setup-android@v3

      - name: Setup Android NDK
        if: inputs.name == 'Android'
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27c
          add-to-path: true

      - name: Verify Build Tools
        run: |
          echo "=== Build Environment ==="
          haxe --version
          lime --version
          if [[ "${{ inputs.name }}" == "Android" ]]; then
            echo "Android SDK: $ANDROID_SDK_ROOT"
            echo "NDK: $ANDROID_NDK_ROOT"
            echo "Java: $JAVA_HOME"
          fi

      - name: Install Dependencies
        run: |
          echo "Running setup command: ${{ inputs.setupCommand }}"
          ${{ inputs.setupCommand }}

          haxelib list

      - name: Configure Android Build
        if: inputs.name == 'Android'
        run: |
          lime setup android

          lime config ANDROID_SDK $ANDROID_SDK_ROOT
          lime config ANDROID_NDK_ROOT $ANDROID_NDK_ROOT
          lime config JAVA_HOME $JAVA_HOME
          lime config ANDROID_SETUP true
          
          echo "Android configuration complete"

      - name: Build Project
        timeout-minutes: 30
        run: |
          echo "Building with arguments: ${{ inputs.buildArgs }}"

          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if haxelib run lime build ${{ inputs.buildArgs }}; then
              echo "Build successful!"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT+1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Build failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                sleep 10
              else
                echo "Build failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done

      - name: Verify Build Output
        run: |
          echo "Checking build output..."
          ls -la ${{ inputs.artifactPath }} || true

          FILE_COUNT=$(find ${{ inputs.artifactPath }} -type f 2>/dev/null | wc -l)
          echo "Found $FILE_COUNT file(s) at ${{ inputs.artifactPath }}"
          
          if [ $FILE_COUNT -eq 0 ]; then
            echo "Error: No build artifacts found!"
            exit 1
          fi

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifactName }}
          path: ${{ inputs.artifactPath }}
          if-no-files-found: error
          retention-days: 7
          compression-level: 9

      - name: Build Summary
        if: always()
        run: |
          echo "=== Build Summary ==="
          echo "Target: ${{ inputs.name }}"
          echo "OS: ${{ inputs.os }}"
          echo "Status: ${{ job.status }}"
          echo "Artifact: ${{ inputs.artifactName }}"