name: Release Build
on:
  workflow_dispatch:
    inputs:
      prerelease:
        description: 'Mark as prerelease?'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  discussions: write

env:
  PROJECT_NAME: PsychEngine
  REPO_PATH: sirthegamercoder/FNF-Psych-Engine-Mobile-Fix
  ARTIFACT_DIR: /tmp/artifacts

jobs:
  validate-repository:
    name: Validate Repository
    runs-on: ubuntu-latest
    outputs:
      commit_hash: ${{ steps.get-commit-hash.outputs.commit_hash }}
      is_valid: ${{ steps.validate.outputs.is_valid }}
    steps:
      - name: Check Repository Ownership
        id: validate
        run: |
          if [[ "$GITHUB_REPOSITORY" != "${{ env.REPO_PATH }}" ]]; then
            echo "is_valid=false" >> $GITHUB_OUTPUT
            echo "Error: Workflow can only run in ${{ env.REPO_PATH }}"
            exit 1
          else
            echo "is_valid=true" >> $GITHUB_OUTPUT
            echo "Repository validation passed"
          fi

      - name: Get Commit Information
        id: get-commit-hash
        if: steps.validate.outputs.is_valid == 'true'
        run: |
          SHORT_SHA="${GITHUB_SHA::8}"
          echo "commit_hash=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Build commit: $SHORT_SHA"

          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "commit_message<<EOF" >> $GITHUB_ENV
          echo "$COMMIT_MSG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

  build-android:
    name: Build Android
    needs: validate-repository
    if: needs.validate-repository.outputs.is_valid == 'true'
    uses: ./.github/workflows/build.yml
    with:
      name: Android
      os: macos-15
      setupCommand: sh ./setup/unix.sh
      buildArgs: "android -final -D officialBuild -v"
      artifactName: android-build-${{ needs.validate-repository.outputs.commit_hash }}
      artifactPath: "export/release/android/bin/app/build/outputs/apk/release/*.apk"
    secrets: inherit

  create-release:
    name: Create Release
    needs: [validate-repository, build-android]
    if: needs.validate-repository.outputs.is_valid == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_url: ${{ steps.create-release.outputs.release_url }}
    steps:
      - name: Create Artifacts Directory
        run: mkdir -p ${{ env.ARTIFACT_DIR }}

      - name: Download Android Artifact
        uses: actions/download-artifact@v4
        with:
          name: android-build-${{ needs.validate-repository.outputs.commit_hash }}
          path: ${{ env.ARTIFACT_DIR }}

      - name: Rename Android Artifact
        run: |
          cd ${{ env.ARTIFACT_DIR }}
          for file in *.apk; do
            if [ -f "$file" ]; then
              new_name="${{ env.PROJECT_NAME }}-Android-${{ needs.validate-repository.outputs.commit_hash }}.apk"
              mv "$file" "$new_name"
              echo "Renamed: $file â†’ $new_name"
            fi
          done

      - name: Create GitHub Release
        id: create-release
        uses: softprops/action-gh-release@v2
        with:
          name: "SirBuild ${{ needs.validate-repository.outputs.commit_hash }}"
          tag_name: "v1.0.4-${{ needs.validate-repository.outputs.commit_hash }}"
          target_commitish: ${{ github.sha }}
          prerelease: ${{ github.event.inputs.prerelease }}
          draft: false
          files: |
            ${{ env.ARTIFACT_DIR }}/*.apk

      - name: Output Release Information
        run: |
          echo "Release created successfully!"
          echo "Artifact uploaded to: ${{ steps.create-release.outputs.release_url }}"
          echo "Tag: v1.0.4-${{ needs.validate-repository.outputs.commit_hash }}"